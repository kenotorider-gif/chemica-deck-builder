<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chemica デッキビルダー</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // アイコンを手動で定義（Lucide の代わり）
        const Search = (props) => React.createElement('svg', { 
          width: props.size || 24, height: props.size || 24, 
          viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', 
          strokeWidth: 2, className: props.className 
        }, 
          React.createElement('circle', { cx: 11, cy: 11, r: 8 }),
          React.createElement('path', { d: 'm21 21-4.35-4.35' })
        );

        const Download = (props) => React.createElement('svg', { 
          width: props.size || 24, height: props.size || 24, 
          viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', 
          strokeWidth: 2, className: props.className 
        }, 
          React.createElement('path', { d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }),
          React.createElement('polyline', { points: '7,10 12,15 17,10' }),
          React.createElement('line', { x1: 12, x2: 12, y1: 15, y2: 3 })
        );

        const Upload = (props) => React.createElement('svg', { 
          width: props.size || 24, height: props.size || 24, 
          viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', 
          strokeWidth: 2, className: props.className 
        }, 
          React.createElement('path', { d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }),
          React.createElement('polyline', { points: '17,8 12,3 7,8' }),
          React.createElement('line', { x1: 12, x2: 12, y1: 3, y2: 15 })
        );

        const Plus = (props) => React.createElement('svg', { 
          width: props.size || 24, height: props.size || 24, 
          viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', 
          strokeWidth: 2, className: props.className 
        }, 
          React.createElement('path', { d: 'M5 12h14' }),
          React.createElement('path', { d: 'M12 5v14' })
        );

        const Minus = (props) => React.createElement('svg', { 
          width: props.size || 24, height: props.size || 24, 
          viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', 
          strokeWidth: 2, className: props.className 
        }, 
          React.createElement('path', { d: 'M5 12h14' })
        );

        const X = (props) => React.createElement('svg', { 
          width: props.size || 24, height: props.size || 24, 
          viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', 
          strokeWidth: 2, className: props.className 
        }, 
          React.createElement('path', { d: 'M18 6 6 18' }),
          React.createElement('path', { d: 'M6 6l12 12' })
        );

        // GitHub + jsDelivr CDN設定
        const GITHUB_REPO = 'kenotorider-gif/chemica-deck-builder';
        const CARD_BASE_URL = `https://cdn.jsdelivr.net/gh/${GITHUB_REPO}@main/cards/`;

        // 設備投資オプション
        const equipmentOptions = [
          { id: "deck_plus", name: "山札+5枚", cost: 1 },
          { id: "compound_zone", name: "化合物ゾーン+1", cost: 1 },
          { id: "compound_zone_3", name: "化合物ゾーン+3", cost: 2 },
          { id: "initial_hand", name: "初期手札+1", cost: 3 },
          { id: "temp_pressure", name: "初期温度・圧力+1", cost: 4 },
          { id: "mulligan", name: "手札引き直し権", cost: 2 },
          { id: "initial_electron", name: "初期電子+1", cost: 4 },
        ];

        const ChemicaDeckBuilder = () => {
          const [activeTab, setActiveTab] = useState('main');
          const [mainDeck, setMainDeck] = useState({});
          const [compoundDeck, setCompoundDeck] = useState({});
          const [equipment, setEquipment] = useState({});
          const [searchTerm, setSearchTerm] = useState('');
          const [selectedCard, setSelectedCard] = useState(null);
          const [showCardModal, setShowCardModal] = useState(false);
          const [allCards, setAllCards] = useState([]);
          const [loading, setLoading] = useState(true);
          const [deckName, setDeckName] = useState('');
          const fileInputRef = useRef(null);

          // GitHub CDN から画像URLを生成（ハイフン形式）
          const getCardImageUrl = (cardName, cost) => {
            const filename = `${cardName}-${cost}.jpg`;
            return `${CARD_BASE_URL}${encodeURIComponent(filename)}`;
          };

          // プレースホルダー画像生成
          const getPlaceholderImage = (cardName, cost) => {
            const displayText = `${cardName}\\n${cost}`;
            return `https://via.placeholder.com/120x180/4299e1/ffffff?text=${encodeURIComponent(displayText)}`;
          };

          // ファイル名からカード情報を解析する関数（ハイフン形式）
          const parseCardFromFilename = (filename) => {
            const match = filename.match(/^([^-]+)-([^.]+)\.jpg$/);
            if (!match) return null;
            
            const [, name, costStr] = match;
            const isCompound = costStr.toLowerCase() === 'n';
            const cost = isCompound ? 'N' : parseInt(costStr);
            
            return {
              name,
              cost,
              isCompound,
              type: isCompound ? 'compound' : 'normal'
            };
          };

          // GitHub のcardsフォルダからカードリストを動的に取得
          const loadCards = async () => {
            setLoading(true);
            
            try {
              const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/cards`);
              
              if (response.ok) {
                const files = await response.json();
                const jpgFiles = files.filter(file => file.name.endsWith('.jpg'));
                
                const cards = jpgFiles.map(file => {
                  const cardInfo = parseCardFromFilename(file.name);
                  if (cardInfo) {
                    return {
                      ...cardInfo,
                      image: getCardImageUrl(cardInfo.name, cardInfo.cost),
                      placeholderImage: getPlaceholderImage(cardInfo.name, cardInfo.cost)
                    };
                  }
                  return null;
                }).filter(Boolean);
                
                setAllCards(cards);
              } else {
                setAllCards([]);
              }
            } catch (error) {
              console.warn('カードリストの取得に失敗しました:', error);
              setAllCards([]);
            }
            
            setLoading(false);
          };

          useEffect(() => {
            loadCards();
          }, []);

          // 設備投資による最大枚数計算
          const getMaxMainDeck = () => {
            return 40 + (equipment.deck_plus ? equipment.deck_plus * 5 : 0);
          };

          const getMaxCompoundDeck = () => {
            let max = 4;
            if (equipment.compound_zone) max += equipment.compound_zone;
            if (equipment.compound_zone_3) max += equipment.compound_zone_3 * 3;
            return max;
          };

          // 検索フィルター
          const filteredCards = useMemo(() => {
            const cards = allCards.filter(card => {
              if (!searchTerm) return true;
              if (!isNaN(searchTerm)) {
                return card.cost === parseInt(searchTerm);
              }
              return card.name.toLowerCase().includes(searchTerm.toLowerCase());
            });

            return cards.sort((a, b) => {
              if (a.cost === 'N' && b.cost !== 'N') return 1;
              if (b.cost === 'N' && a.cost !== 'N') return -1;
              if (a.cost === 'N' && b.cost === 'N') return 0;
              return a.cost - b.cost;
            });
          }, [searchTerm, allCards]);

          // デッキ枚数計算
          const mainDeckCount = Object.values(mainDeck).reduce((sum, count) => sum + count, 0);
          const compoundDeckCount = Object.values(compoundDeck).reduce((sum, count) => sum + count, 0);
          const equipmentCost = Object.entries(equipment).reduce((sum, [key, count]) => {
            const option = equipmentOptions.find(opt => opt.id === key);
            return sum + (option ? option.cost * count : 0);
          }, 0);

          // カード枚数変更
          const changeCardCount = (cardName, newCount) => {
            if (activeTab === 'main') {
              if (newCount === 0) {
                const newDeck = { ...mainDeck };
                delete newDeck[cardName];
                setMainDeck(newDeck);
              } else {
                setMainDeck(prev => ({
                  ...prev,
                  [cardName]: Math.min(newCount, 4)
                }));
              }
            } else if (activeTab === 'compound') {
              const card = allCards.find(c => c.name === cardName);
              if (card) {
                const maxCount = card.name === "硝酸塩" ? 8 : 4;
                if (newCount === 0) {
                  const newDeck = { ...compoundDeck };
                  delete newDeck[cardName];
                  setCompoundDeck(newDeck);
                } else {
                  setCompoundDeck(prev => ({
                    ...prev,
                    [cardName]: Math.min(newCount, maxCount)
                  }));
                }
              }
            }
          };

          // カード追加（旧関数を保持）
          const addCardToDeck = (cardName, count) => {
            const currentCount = (activeTab === 'main' ? mainDeck : compoundDeck)[cardName] || 0;
            changeCardCount(cardName, currentCount + count);
            setShowCardModal(false);
          };

          // 設備投資選択
          const selectEquipment = (equipmentId, count) => {
            const option = equipmentOptions.find(opt => opt.id === equipmentId);
            if (!option) return;

            const newCount = Math.max(0, count);
            const newEquipment = { ...equipment };
            
            if (newCount === 0) {
              delete newEquipment[equipmentId];
            } else {
              newEquipment[equipmentId] = newCount;
            }

            const newCost = Object.entries(newEquipment).reduce((sum, [key, cnt]) => {
              const opt = equipmentOptions.find(o => o.id === key);
              return sum + (opt ? opt.cost * cnt : 0);
            }, 0);

            if (newCost <= 4) {
              setEquipment(newEquipment);
            }
          };

          // エクスポート機能
          const generateDeckList = () => {
            const deckData = {
              version: "1.0",
              timestamp: new Date().toISOString(),
              deckName: deckName || "Untitled_Deck",
              mainDeck,
              compoundDeck,
              equipment,
              metadata: {
                mainDeckCount,
                compoundDeckCount,
                equipmentCost,
                maxMainDeck: getMaxMainDeck(),
                maxCompoundDeck: getMaxCompoundDeck()
              }
            };
            
            const dataStr = JSON.stringify(deckData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const now = new Date();
            const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
            const safeDeckName = (deckName || "Untitled_Deck").replace(/[^a-zA-Z0-9_\-\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g, '_');
            const filename = `${safeDeckName}_${dateStr}.chemica`;
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
          };

          // インポート機能
          const importDeckData = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const deckData = JSON.parse(e.target.result);
                
                if (!deckData.version || deckData.version !== "1.0") {
                  alert('サポートされていないファイル形式です');
                  return;
                }

                if (!deckData.mainDeck || !deckData.compoundDeck || typeof deckData.equipment === 'undefined') {
                  alert('不正なデッキファイルです');
                  return;
                }

                const shouldImport = window.confirm(
                  `このデッキをインポートしますか？\n\n` +
                  `メインデッキ: ${deckData.metadata?.mainDeckCount || 0}枚\n` +
                  `化合物デッキ: ${deckData.metadata?.compoundDeckCount || 0}枚\n` +
                  `設備投資: ${deckData.metadata?.equipmentCost || 0}枠\n\n` +
                  `※現在のデッキは上書きされます`
                );

                if (shouldImport) {
                  setMainDeck(deckData.mainDeck || {});
                  setCompoundDeck(deckData.compoundDeck || {});
                  setEquipment(deckData.equipment || {});
                  setDeckName(deckData.deckName || '');
                  alert('デッキをインポートしました！');
                }

              } catch (error) {
                console.error('Import error:', error);
                alert('ファイルの読み込みに失敗しました');
              }
            };

            reader.readAsText(file);
            event.target.value = '';
          };

          const handleImportClick = () => {
            fileInputRef.current?.click();
          };

          // デッキ表示用のカード配列生成
          const getDeckCards = () => {
            const deck = activeTab === 'main' ? mainDeck : compoundDeck;
            const cards = [];
            
            Object.entries(deck).forEach(([cardName, count]) => {
              const card = allCards.find(c => c.name === cardName);
              if (card) {
                for (let i = 0; i < count; i++) {
                  cards.push({ ...card, key: `${cardName}-${i}` });
                }
              }
            });

            const maxCards = activeTab === 'main' ? getMaxMainDeck() : getMaxCompoundDeck();
            while (cards.length < maxCards) {
              cards.push({ empty: true, key: `empty-${cards.length}` });
            }

            return cards.slice(0, maxCards);
          };

          return React.createElement('div', { className: "w-full max-w-md mx-auto bg-gray-900 text-white min-h-screen" },
            // ヘッダー
            React.createElement('div', { className: "bg-blue-800 p-4" },
              React.createElement('h1', { className: "text-xl font-bold text-center mb-3" }, "Chemica デッキビルダー"),
              React.createElement('input', {
                type: "text",
                placeholder: "デッキ名を入力...",
                value: deckName,
                onChange: (e) => setDeckName(e.target.value),
                className: "w-full px-3 py-2 bg-blue-700 border border-blue-600 rounded text-white placeholder-blue-300 focus:outline-none focus:border-blue-400"
              })
            ),

            // タブ
            React.createElement('div', { className: "flex bg-gray-800" },
              [
                { key: 'main', label: 'メイン', count: mainDeckCount, max: getMaxMainDeck() },
                { key: 'compound', label: '化合物', count: compoundDeckCount, max: getMaxCompoundDeck() },
                { key: 'equipment', label: '設備投資', count: equipmentCost }
              ].map(tab => 
                React.createElement('button', {
                  key: tab.key,
                  onClick: () => setActiveTab(tab.key),
                  className: `flex-1 p-3 text-sm font-medium border-b-2 ${
                    activeTab === tab.key 
                      ? 'border-blue-400 bg-gray-700' 
                      : 'border-transparent hover:border-gray-600'
                  }`
                },
                  tab.label,
                  React.createElement('span', { className: "block text-xs text-gray-400" },
                    tab.key === 'equipment' ? `${tab.count}/4枠` : `${tab.count}/${tab.max || 0}枚`
                  )
                )
              )
            ),

            // デッキエリア
            React.createElement('div', { className: "p-4 bg-gray-800 border-b" },
              activeTab === 'equipment' ? (
                React.createElement('div', { className: "space-y-3" },
                  React.createElement('div', { className: "text-center text-sm text-gray-400 mb-4" }, `予算: ${equipmentCost}/4枠`),
                  equipmentOptions.map(option =>
                    React.createElement('div', { key: option.id, className: "flex items-center justify-between bg-gray-700 p-3 rounded" },
                      React.createElement('div', {},
                        React.createElement('div', { className: "font-medium" }, option.name),
                        React.createElement('div', { className: "text-sm text-gray-400" }, `${option.cost}枠`)
                      ),
                      React.createElement('div', { className: "flex items-center space-x-2" },
                        React.createElement('button', {
                          onClick: () => selectEquipment(option.id, (equipment[option.id] || 0) - 1),
                          className: "w-8 h-8 bg-red-600 hover:bg-red-700 rounded flex items-center justify-center",
                          disabled: !equipment[option.id]
                        }, React.createElement(Minus, { size: 16 })),
                        React.createElement('span', { className: "w-8 text-center" }, equipment[option.id] || 0),
                        React.createElement('button', {
                          onClick: () => selectEquipment(option.id, (equipment[option.id] || 0) + 1),
                          className: "w-8 h-8 bg-green-600 hover:bg-green-700 rounded flex items-center justify-center",
                          disabled: equipmentCost >= 4
                        }, React.createElement(Plus, { size: 16 }))
                      )
                    )
                  )
                )
              ) : (
                React.createElement('div', { className: "grid grid-cols-5 gap-2 h-64 overflow-y-auto" },
                  getDeckCards().map(card =>
                    React.createElement('div', {
                      key: card.key,
                      onClick: card.empty ? undefined : () => {
                        setSelectedCard(card);
                        setShowCardModal(true);
                      },
                      className: `aspect-[2/3] rounded border-2 overflow-hidden ${
                        card.empty 
                          ? 'border-dashed border-gray-600 bg-gray-800' 
                          : 'border-gray-600 bg-gray-700 cursor-pointer hover:border-blue-400 transition-colors'
                      }`
                    },
                      !card.empty && React.createElement('img', {
                        src: card.image,
                        alt: card.name,
                        className: "w-full h-full object-cover",
                        onError: (e) => {
                          e.target.src = card.placeholderImage;
                        }
                      })
                    )
                  )
                )
              )
            ),

            // 検索バー
            activeTab !== 'equipment' && React.createElement('div', { className: "p-4 bg-gray-800" },
              React.createElement('div', { className: "relative" },
                React.createElement(Search, { className: "absolute left-3 top-3 h-4 w-4 text-gray-400" }),
                React.createElement('input', {
                  type: "text",
                  placeholder: "カード名またはコストで検索...",
                  value: searchTerm,
                  onChange: (e) => setSearchTerm(e.target.value),
                  className: "w-full pl-10 pr-4 py-2 bg-gray-700 border border-gray-600 rounded text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"
                })
              )
            ),

            // カードリスト
            activeTab !== 'equipment' && React.createElement('div', { className: "flex-1 overflow-y-auto" },
              loading ? (
                React.createElement('div', { className: "flex items-center justify-center p-8" },
                  React.createElement('div', { className: "text-gray-400" }, "カードデータを読み込み中...")
                )
              ) : allCards.length === 0 ? (
                React.createElement('div', { className: "flex flex-col items-center justify-center p-8 text-center" },
                  React.createElement('div', { className: "text-gray-400 mb-2" }, "カードが見つかりません"),
                  React.createElement('div', { className: "text-sm text-gray-500" },
                    "GitHub リポジトリの cards フォルダに",
                    React.createElement('br'),
                    "「カード名-コスト.jpg」形式でファイルを配置してください"
                  )
                )
              ) : (
                React.createElement('div', { className: "flex overflow-x-auto gap-2 p-4" },
                  filteredCards
                    .filter(card => 
                      activeTab === 'main' 
                        ? !card.isCompound 
                        : card.isCompound
                    )
                    .map(card =>
                      React.createElement('div', {
                        key: card.name,
                        onClick: () => {
                          setSelectedCard(card);
                          setShowCardModal(true);
                        },
                        className: "flex-shrink-0 w-24 cursor-pointer hover:scale-105 transition-transform"
                      },
                        React.createElement('div', { className: "aspect-[2/3] bg-blue-600 rounded border-2 border-gray-600 overflow-hidden" },
                          React.createElement('img', {
                            src: card.image,
                            alt: card.name,
                            className: "w-full h-full object-cover",
                            onError: (e) => {
                              e.target.src = card.placeholderImage;
                            }
                          })
                        ),
                        React.createElement('div', { className: "text-center text-xs mt-1 text-gray-400" },
                          `${((activeTab === 'main' ? mainDeck : compoundDeck)[card.name] || 0)}枚`
                        )
                      )
                    )
                )
              )
            ),

            // エクスポート・インポートボタン
            React.createElement('div', { className: "p-4 bg-gray-800 border-t space-y-2" },
              React.createElement('button', {
                onClick: generateDeckList,
                className: "w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded font-medium flex items-center justify-center"
              },
                React.createElement(Download, { size: 16, className: "mr-2" }),
                "デッキをエクスポート (.chemica)"
              ),
              
              React.createElement('button', {
                onClick: handleImportClick,
                className: "w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded font-medium flex items-center justify-center"
              },
                React.createElement(Upload, { size: 16, className: "mr-2" }),
                "デッキをインポート"
              ),
              
              React.createElement('input', {
                ref: fileInputRef,
                type: "file",
                accept: ".chemica,.json",
                onChange: importDeckData,
                style: { display: 'none' }
              }),
              
              React.createElement('div', { className: "text-center text-xs text-gray-500 mt-2" },
                `メイン: ${mainDeckCount}/${getMaxMainDeck()}枚 | 化合物: ${compoundDeckCount}/${getMaxCompoundDeck()}枚 | 設備: ${equipmentCost}/4枠`
              )
            ),

            // カード詳細モーダル（サイズを2.5倍に拡大）
            showCardModal && selectedCard && React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" },
              React.createElement('div', { className: "bg-gray-800 p-6 rounded-lg max-w-xl w-full mx-4" },
                React.createElement('div', { className: "flex justify-between items-center mb-4" },
                  React.createElement('h3', { className: "text-lg font-bold" }, selectedCard.name),
                  React.createElement('button', {
                    onClick: () => setShowCardModal(false),
                    className: "text-gray-400 hover:text-white"
                  }, React.createElement(X, { size: 20 }))
                ),
                
                React.createElement('div', { className: "text-center mb-4" },
                  React.createElement('div', { className: "aspect-[2/3] w-80 mx-auto rounded border-2 border-gray-600 overflow-hidden" },
                    React.createElement('img', {
                      src: selectedCard.image,
                      alt: selectedCard.name,
                      className: "w-full h-full object-cover",
                      onError: (e) => {
                        e.target.src = selectedCard.placeholderImage;
                      }
                    })
                  )
                ),

                React.createElement('div', { className: "flex items-center justify-center space-x-4 mb-4" },
                  React.createElement('button', {
                    onClick: () => {
                      const currentCount = ((activeTab === 'main' ? mainDeck : compoundDeck)[selectedCard.name] || 0);
                      changeCardCount(selectedCard.name, Math.max(0, currentCount - 1));
                    },
                    className: "w-10 h-10 bg-red-600 hover:bg-red-700 text-white rounded flex items-center justify-center font-bold",
                    disabled: !((activeTab === 'main' ? mainDeck : compoundDeck)[selectedCard.name] || 0)
                  }, React.createElement(Minus, { size: 18 })),
                  
                  React.createElement('div', { className: "flex flex-col items-center" },
                    React.createElement('span', { className: "text-2xl font-bold" }, 
                      ((activeTab === 'main' ? mainDeck : compoundDeck)[selectedCard.name] || 0)
                    ),
                    React.createElement('span', { className: "text-sm text-gray-400" }, "枚")
                  ),
                  
                  React.createElement('button', {
                    onClick: () => {
                      const currentCount = ((activeTab === 'main' ? mainDeck : compoundDeck)[selectedCard.name] || 0);
                      const card = allCards.find(c => c.name === selectedCard.name);
                      const maxCount = card && card.name === "珪酸塩塩" ? 8 : 4;
                      changeCardCount(selectedCard.name, Math.min(maxCount, currentCount + 1));
                    },
                    className: "w-10 h-10 bg-green-600 hover:bg-green-700 text-white rounded flex items-center justify-center font-bold",
                    disabled: (() => {
                      const currentCount = ((activeTab === 'main' ? mainDeck : compoundDeck)[selectedCard.name] || 0);
                      const card = allCards.find(c => c.name === selectedCard.name);
                      const maxCount = card && card.name === "珪酸塩" ? 8 : 4;
                      return currentCount >= maxCount;
                    })()
                  }, React.createElement(Plus, { size: 18 }))
                ),
              )
            )
          );
        };

        ReactDOM.render(React.createElement(ChemicaDeckBuilder), document.getElementById('root'));
    </script>
</body>
</html>
